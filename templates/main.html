<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HowsTheWeather</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="logo">HowsTheWeather</div>
        <div class="location">
            <span class="location-icon">ğŸ“</span>
            <span id="location-name">í˜„ì¬ ìœ„ì¹˜ë¥¼ í™•ì¸ ì¤‘...</span>
        </div>
        <a href="/location_search.html" class="search-location">ì§€ì—­ê²€ìƒ‰</a>
    </header>
    <main>
        <section class="main-content">
            <div class="card current-weather">
                <h2>í˜„ì¬ ë‚ ì”¨</h2>
                <div class="temperature-range">
                    <span class="low-temp"></span> ~ <span class="high-temp"></span>
                </div>
                <div class="current-temp">
                    <span id="current-temp"></span>
                    <span class="weather-icon"></span>
                </div>
                <div id="current-date" class="time">í˜„ì¬ ì‹œê°„: </div>
            </div>
            <div class="card live-comments">
                <h2>ì‹¤ì‹œê°„ ëŒ“ê¸€</h2>
                <ul id="comments-list">
                    {% if comments %}
                        {% for comment in comments %}
                        <li><strong>{{ comment.name }}</strong>: {{ comment.comment }}</li>
                        {% endfor %}
                    {% else %}
                        <li>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                    {% endif %}
                </ul>
                <form id="comment-form" method="post" action="/comments/">
                    <input type="text" id="comment-name" name="name" placeholder="ì´ë¦„" required>
                    <input type="text" id="comment-input" name="comment" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required>
                    <input type="hidden" id="comment-lat" name="lat" value="{{ lat }}">
                    <input type="hidden" id="comment-lon" name="lon" value="{{ lon }}">
                    <button type="submit">ëŒ“ê¸€ ë‹¬ê¸°</button>
                </form>
            </div>
        </section>
        <section class="forecast">
            <div class="card weekly-forecast">
                <h2>ì£¼ê°„ ì˜ˆë³´</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ì˜¨ë„</th>
                                <th>ë‚ ì”¨</th>
                            </tr>
                        </thead>
                        <tbody id="weekly-forecast-body">
                            <!-- ì£¼ê°„ ì˜ˆë³´ í–‰ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card hourly-forecast">
                <h2>ì‹œê°„ë³„ ì˜ˆë³´</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ì‹œê°„</th>
                                <th>ì˜¨ë„</th>
                                <th>ë‚ ì”¨</th>
                            </tr>
                        </thead>
                        <tbody id="hourly-forecast-body">
                            <!-- ì‹œê°„ë³„ ì˜ˆë³´ í–‰ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Weather icon and description translations -->
    <script>
        function translateWeatherDescription(description) {
            const descriptions = {
                "clear sky": "ë§‘ìŒ",
                "few clouds": "êµ¬ë¦„ ì¡°ê¸ˆ",
                "scattered clouds": "êµ¬ë¦„ ë‚Œ",
                "broken clouds": "êµ¬ë¦„ ë§ìŒ",
                "shower rain": "ì†Œë‚˜ê¸°",
                "rain": "ë¹„",
                "thunderstorm": "ì²œë‘¥ë²ˆê°œ",
                "snow": "ëˆˆ",
                "mist": "ì•ˆê°œ",
                "light rain": "ì•½í•œ ë¹„",
                "moderate rain": "ë³´í†µ ë¹„",
                "heavy intensity rain": "ê°•í•œ ë¹„",
                "overcast clouds": "íë¦¼"
            };
            return descriptions[description] || description;
        }

        function formatDate(date) {
            const daysOfWeek = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
            return `${date.getMonth() + 1}/${date.getDate()} (${daysOfWeek[date.getDay()]})`;
        }
    </script>

    <!-- jQuery library -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <!-- JavaScript for fetching weather data and handling comments -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const weatherApiKey = 'a71cf8f55278a20a0840a3e6fcba9384'; // OpenWeatherMap API í‚¤
            const locationNameElement = document.getElementById('location-name');
        
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ lat, lonì„ ì½ì–´ì˜¤ëŠ” í•¨ìˆ˜
            function getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    lat: parseFloat(params.get('lat')),
                    lon: parseFloat(params.get('lon')),
                    place: params.get('place')
                };
            }
        
            // í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
            function getCurrentPosition() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lon = position.coords.longitude.toFixed(6);
                        updateWeather(lat, lon);
                        getLocationName(lat, lon);
        
                        // ìœ„ì¹˜ ì •ë³´ë¥¼ ëŒ“ê¸€ í¼ì— ì„¤ì •
                        document.getElementById('comment-lat').value = lat;
                        document.getElementById('comment-lon').value = lon;
                    }, error => {
                        locationNameElement.textContent = 'ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€';
                        console.error('Error fetching location:', error);
                    });
                } else {
                    locationNameElement.textContent = 'ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€';
                    console.error('Geolocation not supported by this browser');
                }
            }
        
            // ë‚ ì”¨ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
            function updateWeather(lat, lon) {
                fetch(`https://api.openweathermap.org/data/3.0/onecall?lat=${lat}&lon=${lon}&exclude=minutely,alerts&appid=${weatherApiKey}&units=metric`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Weather Data:', data);
        
                        // í˜„ì¬ ë‚ ì”¨ ì—…ë°ì´íŠ¸
                        const currentTemp = data.current.temp.toFixed(1);
                        const minTemp = data.daily[0].temp.min.toFixed(1);
                        const maxTemp = data.daily[0].temp.max.toFixed(1);
                        const weatherIcon = data.current.weather[0].icon;
                        const now = new Date();
                        const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
        
                        document.querySelector('.low-temp').textContent = `${minTemp}Â°C`;
                        document.querySelector('.high-temp').textContent = `${maxTemp}Â°C`;
                        document.getElementById('current-temp').textContent = `${currentTemp}Â°C`;
                        document.querySelector('.weather-icon').innerHTML = `<img src="https://openweathermap.org/img/wn/${weatherIcon}@2x.png" alt="Weather icon">`;
                        document.getElementById('current-date').textContent = formattedDate;
        
                        // ì£¼ê°„ ì˜ˆë³´ ì—…ë°ì´íŠ¸
                        const weeklyForecast = document.getElementById('weekly-forecast-body');
                        weeklyForecast.innerHTML = '';
        
                        data.daily.forEach(day => {
                            const date = new Date(day.dt * 1000);
                            const dayOfWeek = `${date.getMonth() + 1}/${date.getDate()} (${['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()]})`;
                            const tempMin = day.temp.min.toFixed(1);
                            const tempMax = day.temp.max.toFixed(1);
                            const weatherDescription = translateWeatherDescription(day.weather[0].description);
                            const weatherIcon = day.weather[0].icon;
        
                            const weeklyHtml = `<tr>
                                <td>${dayOfWeek}</td>
                                <td>${tempMin}Â°C / ${tempMax}Â°C</td>
                                <td><img src="https://openweathermap.org/img/wn/${weatherIcon}.png" alt="${weatherDescription}">${weatherDescription}</td>
                            </tr>`;
        
                            weeklyForecast.insertAdjacentHTML('beforeend', weeklyHtml);
                        });
        
                        // ì‹œê°„ë³„ ì˜ˆë³´ë¥¼ ë‚ ì§œë³„ë¡œ ë‚˜ëˆ„ì–´ ì—…ë°ì´íŠ¸
                        const hourlyForecast = document.getElementById('hourly-forecast-body');
                        hourlyForecast.innerHTML = '';
        
                        let lastDate = '';
                        data.hourly.forEach(hour => {
                            const date = new Date(hour.dt * 1000);
                            const hourOfDay = date.getHours();
                            const temp = hour.temp.toFixed(1);
                            const weatherDescription = translateWeatherDescription(hour.weather[0].description);
                            const weatherIcon = hour.weather[0].icon;
        
                            const currentDate = `${date.getMonth() + 1}/${date.getDate()}`;
                            if (currentDate !== lastDate) {
                                lastDate = currentDate;
                                hourlyForecast.insertAdjacentHTML('beforeend', `<tr><td colspan="3"><strong>${formatDate(date)}</strong></td></tr>`);
                            }
        
                            const hourlyHtml = `<tr>
                                <td>${hourOfDay}ì‹œ</td>
                                <td>${temp}Â°C</td>
                                <td><img src="https://openweathermap.org/img/wn/${weatherIcon}.png" alt="${weatherDescription}">${weatherDescription}</td>
                            </tr>`;
        
                            hourlyForecast.insertAdjacentHTML('beforeend', hourlyHtml);
                        });
                    })
                    .catch(error => console.error('Error fetching weather data:', error));
            }
        
            // ìœ„ì¹˜ ì´ë¦„ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
            function getLocationName(lat, lon) {
                fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=ko`)
                    .then(response => response.json())
                    .then(data => {
                        const locationName = data.city || data.locality || 'ì•Œ ìˆ˜ ì—†ëŠ” ìœ„ì¹˜';
                        locationNameElement.textContent = locationName;
                    })
                    .catch(error => {
                        locationNameElement.textContent = 'ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€';
                        console.error('Error fetching location name:', error);
                    });
            }
        
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ë‚ ì”¨ë¥¼ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜, í˜„ì¬ ìœ„ì¹˜ë¥¼ ì‚¬ìš©
            const params = getUrlParams();
            if (params.lat && params.lon) {
                const lat = params.lat.toFixed(6);
                const lon = params.lon.toFixed(6);
                updateWeather(lat, lon);
                locationNameElement.textContent = params.place || 'ì„ íƒí•œ ìœ„ì¹˜';
        
                // ìœ„ì¹˜ ì •ë³´ë¥¼ ëŒ“ê¸€ í¼ì— ì„¤ì •
                document.getElementById('comment-lat').value = lat;
                document.getElementById('comment-lon').value = lon;
            } else {
                getCurrentPosition();
            }
        
            // í¼ ì œì¶œ ì‹œ ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€
            const commentForm = document.getElementById('comment-form');
            commentForm.addEventListener('submit', (event) => {
                event.preventDefault();
        
                const name = document.getElementById('comment-name').value.trim();
                const comment = document.getElementById('comment-input').value.trim();
                const lat = document.getElementById('comment-lat').value;
                const lon = document.getElementById('comment-lon').value;
        
                // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
                console.log('Submitting comment:', {
                    name,
                    comment,
                    lat,
                    lon
                });
        
                if (!name || !comment) {
                    alert('ì´ë¦„ê³¼ ëŒ“ê¸€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
        
                if (!lat || !lon) {
                    alert('ìœ„ì¹˜ ì •ë³´ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ìœ„ì¹˜ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }
        
                const formData = new FormData(commentForm);
        
                fetch('/comments/', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.detail || 'ëŒ“ê¸€ ì œì¶œ ì‹¤íŒ¨');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error submitting comment:', error);
                    alert('ëŒ“ê¸€ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
            });
        });
        
        
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HowstheWeather</title>
    <link rel="stylesheet" href="design.css">
</head>
<body>
    <header>
        <div class="logo">HowsTheWeather</div>
        <div class="search-bar">
            <input type="text" placeholder="검색">
            <button>검색</button>
        </div>
        <div class="location">
            <span class="location-icon">📍</span>
            <p id="location">위치 정보 없음</p>
            <button class="btn-location" onclick="getLocation()">위치 정보와 날씨 가져오기</button>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="#">About us</a></li>
            <li><a href="#">Contact</a></li>
        </ul>
    </nav>

    <main>
        <div class="current-weather">
            <h2>현재 날씨</h2>
            <p id="current-weather">날씨 정보 없음</p>
        </div>

        <div class="comment-section">
            <h2>실시간 댓글</h2>
            <ul id="live-comments">
                <li>No comments yet</li>
            </ul>
            <textarea id="comment-input" placeholder="댓글을 입력하세요"></textarea>
            <button onclick="submitComment()">댓글 등록</button>
        </div>

        <div class="forecast">
            <div class="hourly-forecast">
                <h2>시간별 예보</h2>
                <div id="hourly-weather">시간별 예보 정보 없음</div>
            </div>

            <div class="weekly-forecast">
                <h2>주간 예보</h2>
                <div id="forecast-weather">주간 예보 정보 없음</div>
            </div>
        </div>
    </main>

    <footer>
        <p>© 2024 날씨 예보. All rights reserved.</p>
    </footer>

    <script>
        const weatherApiKey = '3ad08992386749b7956717e6b2538ba7'; // Weatherbit API 키
        const geocodingApiKey = 'e0ae11f71ea14c5bbf91ba8e8c17ee95'; // OpenCage Geocoding API 키를 여기에 입력하세요.
        const serviceKey = 'xRFh/7MePsQJHhC6N30b2YiwwanKNDkhDlioe9ZLDYH/isyTZrarXJ+7RpY5UrOyy0mRpaR7tGO4OOpCsXfm2g=='; // 발급받은 서비스 키를 여기에 입력하세요.

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                document.getElementById("location").innerHTML = "이 브라우저는 Geolocation을 지원하지 않습니다.";
            }
        }

        function showPosition(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            getCityName(latitude, longitude);
            getCurrentWeather(latitude, longitude);
            getHourlyWeather(latitude, longitude);
            getForecastWeather(latitude, longitude);
        }

        function getCityName(latitude, longitude) {
            const geocodingUrl = `https://api.opencagedata.com/geocode/v1/json?q=${latitude}+${longitude}&key=${geocodingApiKey}&language=ko&pretty=1`;

            fetch(geocodingUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Geocoding API error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Geocoding data:', data);
                    const locationInfo = data.results[0].components;
                    const city = locationInfo.city || locationInfo.town || locationInfo.village || "Unknown city";
                    const country = locationInfo.country;
                    document.getElementById("location").innerHTML = `위치: ${country} ${city}`;
                })
                .catch(error => {
                    console.error('위치 정보를 가져오는 중 오류 발생:', error);
                    document.getElementById("location").innerHTML = "위치 정보를 가져오는 중 오류가 발생했습니다.";
                });
        }

        function getCurrentWeather(latitude, longitude) {
            const weatherUrl = `https://api.weatherbit.io/v2.0/current?lat=${latitude}&lon=${longitude}&key=${weatherApiKey}&lang=kr&units=M`;

            fetch(weatherUrl)
                .then(response => {
                    console.log('Fetch response:', response);
                    if (!response.ok) {
                        throw new Error(`Weather API error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Weather data:', data);
                    const temperature = data.data[0].temp;
                    const weatherDescription = data.data[0].weather.description;
                    document.getElementById("current-weather").innerHTML = `현재 온도: ${temperature}°C<br>날씨: ${weatherDescription}`;
                })
                .catch(error => {
                    console.error('날씨 정보를 가져오는 중 오류 발생:', error);
                    document.getElementById("current-weather").innerHTML = "날씨 정보를 가져오는 중 오류가 발생했습니다.";
                });
        }
        function getHourlyWeather(latitude, longitude, serviceKey) {
    const today = new Date();
    const yyyy = today.getFullYear().toString();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const baseDate = `${yyyy}${mm}${dd}`;
    const baseTimes = ['0200', '0500', '0800', '1100', '1400', '1700', '2000', '2300'];

    const promises = baseTimes.map(baseTime => {
        const hourlyWeatherUrl = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${serviceKey}&numOfRows=12&pageNo=1&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${longitude}&ny=${latitude}`;
        
        return fetch(hourlyWeatherUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Hourly Weather API error! status: ${response.status}`);
                }
                return response.json();
            });
    });

    Promise.all(promises)
        .then(responses => {
            let hourlyHtml = '';
            responses.forEach(data => {
                const items = data.response.body.items.item;
                items.forEach(item => {
                    hourlyHtml += `
                        <div>
                            <p>발표일자: ${item.baseDate}</p>
                            <p>발표시각: ${item.baseTime}</p>
                            <p>예보일자: ${item.fcstDate}</p>
                            <p>예보시각: ${item.fcstTime}</p>
                            <p>자료구분문자: ${item.category}</p>
                            <p>예보 값: ${item.fcstValue}</p>
                            <p>좌표 (X, Y): (${item.nx}, ${item.ny})</p>
                            <hr>
                        </div>
                    `;
                });
            });
            document.getElementById("hourly-weather").innerHTML = hourlyHtml;
        })
        .catch(error => {
            console.error('시간별 예보를 가져오는 중 오류 발생:', error);
            document.getElementById("hourly-weather").innerHTML = "시간별 예보를 가져오는 중 오류가 발생했습니다.";
        });
}

        function getForecastWeather(latitude, longitude) {
            const forecastUrl = `https://api.weatherbit.io/v2.0/forecast/daily?lat=${latitude}&lon=${longitude}&key=${weatherApiKey}&lang=kr&units=M&days=7`;

            fetch(forecastUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Weather API error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Forecast data:', data);
                    const forecastWeather = data.data;
                    let forecastHtml = '<ul>';
                    forecastWeather.forEach(day => {
                        const date = new Date(day.datetime).toLocaleDateString();
                        const temperature = day.temp;
                        const description = day.weather.description;
                        forecastHtml += `<li>${date}: ${temperature}°C, ${description}</li>`;
                    });
                    forecastHtml += '</ul>';
                    document.getElementById("forecast-weather").innerHTML = forecastHtml;
                })
                .catch(error => {
                    console.error('주간 예보를 가져오는 중 오류 발생:', error);
                    document.getElementById("forecast-weather").innerHTML = "주간 예보를 가져오는 중 오류가 발생했습니다.";
                });
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    document.getElementById("location").innerHTML = "사용자가 위치 정보 제공을 거부했습니다.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    document.getElementById("location").innerHTML = "위치 정보를 사용할 수 없습니다.";
                    break;
                case error.TIMEOUT:
                    document.getElementById("location").innerHTML = "위치 정보를 가져오는 데 시간이 초과되었습니다.";
                    break;
                case error.UNKNOWN_ERROR:
                    document.getElementById("location").innerHTML = "알 수 없는 오류가 발생했습니다.";
                    break;
            }
        }

        function submitComment() {
            const commentInput = document.getElementById("comment-input");
            const commentText = commentInput.value.trim();
            if (commentText !== "") {
                const commentList = document.getElementById("live-comments");
                const newComment = document.createElement("li");
                newComment.textContent = commentText;
                commentList.appendChild(newComment);
                commentInput.value = "";
            }
        }
    </script>
</body>
</html>
